<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Encryption - Realistic Path (License Server)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.9.3/shaka-player.compiled.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .content {
            padding: 20px;
        }
        .video-container {
            margin: 20px 0;
            text-align: center;
        }
        video {
            width: 100%;
            max-width: 800px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover {
            background: #ff5252;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .auth-panel {
            background: #fff3e0;
            border: 1px solid #ffcc02;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        .auth-panel input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            margin: 0 10px;
            font-family: 'Courier New', monospace;
        }
        .info-panel {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        .info-panel h3 {
            margin-top: 0;
            color: #495057;
        }
        .url-display {
            font-family: 'Courier New', monospace;
            background: #e9ecef;
            padding: 8px;
            border-radius: 3px;
            word-break: break-all;
            font-size: 12px;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.auth-error {
            background: #f4cccc;
            color: #cc0000;
            border: 1px solid #ff9999;
        }
        .explanation {
            background: #ffebee;
            border-left: 4px solid #ff6b6b;
            padding: 15px;
            margin: 20px 0;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 10px;
            max-height: 250px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .license-info {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Video Encryption Pipeline</h1>
            <p>Realistic Path - License Server Authentication</p>
        </div>
        
        <div class="content">
            <div class="explanation">
                <h3>üéØ Realistic Path Explanation</h3>
                <p>This demo uses a <strong>license server</strong> with authentication, which means:</p>
                <ul>
                    <li>üîê Keys are stored securely on the server</li>
                    <li>üîë Player requests licenses from the server</li>
                    <li>üõ°Ô∏è Authentication is required to get licenses</li>
                    <li>‚úÖ This simulates real-world DRM workflows</li>
                    <li>üöÄ Production-ready architecture pattern</li>
                </ul>
            </div>

            <div class="auth-panel">
                <h3>üîê Authentication Settings</h3>
                <label>
                    Auth Token: 
                    <input type="text" id="authToken" value="devtoken" placeholder="Enter auth token">
                </label>
                <button onclick="testAuth()">üß™ Test Auth</button>
                <p><small>Available tokens: devtoken, testtoken, demo123</small></p>
            </div>

            <div class="video-container">
                <video id="video" controls poster="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjQ1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5FbmNyeXB0ZWQgVmlkZW8gUGxheWVyPC90ZXh0Pjwvc3ZnPg==">
                    Your browser does not support the video tag.
                </video>
            </div>

            <div class="controls">
                <button id="loadVideo">üé¨ Load Encrypted Video</button>
                <button id="testLicenseServer">üîß Test License Server</button>
                <button id="reloadConfig">üîÑ Reload Configuration</button>
                <button id="simulateAuthFailure">‚ùå Simulate Auth Failure</button>
            </div>

            <div id="status" class="status" style="display: none;"></div>

            <div class="grid">
                <div class="info-panel">
                    <h3>üìã Configuration</h3>
                    <p><strong>Manifest URL:</strong></p>
                    <div id="manifestUrl" class="url-display">Loading...</div>
                    <p><strong>License Server URL:</strong></p>
                    <div id="licenseUrl" class="url-display">Loading...</div>
                </div>

                <div class="license-info">
                    <h3>üîë License Server Status</h3>
                    <p><strong>Server Health:</strong> <span id="serverHealth">Unknown</span></p>
                    <p><strong>Keys Available:</strong> <span id="serverKeys">Unknown</span></p>
                    <p><strong>Last License Request:</strong> <span id="lastLicenseRequest">None</span></p>
                </div>
            </div>

            <div class="info-panel">
                <h3>üìù Event Log</h3>
                <div id="eventLog" class="log"></div>
            </div>

            <div class="explanation">
                <h3>üîß How License Server Works</h3>
                <ol>
                    <li>Video player detects encrypted content in the manifest</li>
                    <li>Browser EME requests a license for the content</li>
                    <li>Shaka Player sends authenticated request to license server</li>
                    <li>License server validates the token and returns encryption keys</li>
                    <li>Browser uses keys to decrypt and play the video</li>
                </ol>
                <p><strong>Compare:</strong> Try the <a href="quick-path.html">Quick Path</a> without license server!</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let player;
        let config = null;

        // Logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('eventLog');
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(logEntry.trim());
        }

        // Status display function
        function showStatus(message, type = 'loading') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            statusElement.style.display = 'block';
            
            if (type === 'success' || type === 'error' || type === 'auth-error') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 7000);
            }
        }

        // Get current auth token
        function getAuthToken() {
            return document.getElementById('authToken').value.trim();
        }

        // Load player configuration
        async function loadConfig() {
            try {
                showStatus('Loading configuration...', 'loading');
                const response = await fetch('/player-config.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                config = await response.json();
                
                // Update UI with configuration
                document.getElementById('manifestUrl').textContent = config.manifestUrl;
                document.getElementById('licenseUrl').textContent = config.licenseUrl;
                
                log(`Configuration loaded successfully`);
                log(`Manifest: ${config.manifestUrl}`);
                log(`License Server: ${config.licenseUrl}`);
                showStatus('Configuration loaded successfully!', 'success');
                
                // Test license server health
                await checkServerHealth();
                
                return config;
            } catch (error) {
                log(`Failed to load configuration: ${error.message}`, 'error');
                showStatus('Failed to load configuration. Make sure you\'ve run the packaging script.', 'error');
                
                // Show default values
                document.getElementById('manifestUrl').textContent = 'Configuration not found';
                document.getElementById('licenseUrl').textContent = 'Run npm run package-video';
                
                throw error;
            }
        }

        // Check license server health
        async function checkServerHealth() {
            try {
                const healthUrl = 'http://localhost:8443/health';
                const response = await fetch(healthUrl);
                
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }
                
                const health = await response.json();
                
                document.getElementById('serverHealth').textContent = 'üü¢ Online';
                document.getElementById('serverKeys').textContent = `${health.keysLoaded} keys`;
                
                log(`License server health check: ${health.status}`);
                log(`Server has ${health.keysLoaded} encryption keys loaded`);
                
                return true;
            } catch (error) {
                document.getElementById('serverHealth').textContent = 'üî¥ Offline';
                document.getElementById('serverKeys').textContent = 'Unknown';
                
                log(`License server health check failed: ${error.message}`, 'error');
                log('Make sure license server is running: npm start', 'error');
                
                return false;
            }
        }

        // Test authentication
        async function testAuth() {
            const token = getAuthToken();
            if (!token) {
                showStatus('Please enter an auth token', 'error');
                return;
            }
            
            try {
                showStatus('Testing authentication...', 'loading');
                log(`Testing auth with token: ${token}`);
                
                const testUrl = `http://localhost:8443/license?token=${encodeURIComponent(token)}`;
                const response = await fetch(testUrl);
                
                if (response.status === 403) {
                    throw new Error('Authentication failed - invalid token');
                } else if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const licenseData = await response.json();
                const keyCount = licenseData.keys ? licenseData.keys.length : 0;
                
                log(`Authentication successful! Received ${keyCount} keys`);
                showStatus(`Authentication successful! Server returned ${keyCount} encryption keys.`, 'success');
                
                return true;
            } catch (error) {
                log(`Authentication failed: ${error.message}`, 'error');
                showStatus(`Authentication failed: ${error.message}`, 'auth-error');
                return false;
            }
        }

        // Test license server endpoint
        async function testLicenseServer() {
            const token = getAuthToken();
            if (!token) {
                showStatus('Please enter an auth token first', 'error');
                return;
            }
            
            try {
                showStatus('Testing license server...', 'loading');
                log('Testing license server endpoint...');
                
                // First check server health
                const healthOk = await checkServerHealth();
                if (!healthOk) {
                    throw new Error('License server is not responding');
                }
                
                // Test authentication
                const authOk = await testAuth();
                if (!authOk) {
                    return; // Auth test already showed error
                }
                
                showStatus('License server test completed successfully!', 'success');
                
            } catch (error) {
                log(`License server test failed: ${error.message}`, 'error');
                showStatus(`License server test failed: ${error.message}`, 'error');
            }
        }

        // Initialize Shaka Player
        async function initPlayer() {
            try {
                log('Initializing Shaka Player...');
                
                // Install polyfills
                shaka.polyfill.installAll();
                
                // Check for browser support
                if (!shaka.Player.isBrowserSupported()) {
                    throw new Error('Browser does not support Shaka Player');
                }
                
                // Create player
                const video = document.getElementById('video');
                player = new shaka.Player(video);
                
                // Configure error handling
                player.addEventListener('error', (event) => {
                    const error = event.detail;
                    log(`Player error: ${error.message}`, 'error');
                    showStatus(`Playback error: ${error.message}`, 'error');
                    
                    if (error.message.includes('LICENSE')) {
                        log('HINT: Check license server authentication and key configuration', 'error');
                    }
                });
                
                log('Shaka Player initialized successfully');
                return player;
            } catch (error) {
                log(`Failed to initialize player: ${error.message}`, 'error');
                showStatus('Failed to initialize video player', 'error');
                throw error;
            }
        }

        // Load and play encrypted video
        async function loadVideo() {
            try {
                if (!config) {
                    await loadConfig();
                }
                
                if (!player) {
                    await initPlayer();
                }
                
                const token = getAuthToken();
                if (!token) {
                    showStatus('Please enter an auth token first', 'error');
                    return;
                }
                
                showStatus('Loading encrypted video...', 'loading');
                log('Configuring license server...');
                
                // Build license URL with token
                const licenseUrl = `${config.licenseUrl.split('?')[0]}?token=${encodeURIComponent(token)}`;
                
                // Configure license server
                player.configure({
                    drm: {
                        servers: {
                            'org.w3.clearkey': licenseUrl
                        }
                    }
                });
                
                log(`Configured license server: ${licenseUrl}`);
                log('Loading manifest...');
                
                // Track license requests
                const originalNetworkingEngine = player.getNetworkingEngine();
                if (originalNetworkingEngine) {
                    originalNetworkingEngine.registerRequestFilter((type, request) => {
                        if (request.uris[0].includes('/license')) {
                            log(`License request: ${request.method} ${request.uris[0]}`);
                            document.getElementById('lastLicenseRequest').textContent = new Date().toLocaleTimeString();
                        }
                    });
                }
                
                // Load the manifest
                await player.load(config.manifestUrl);
                
                log('Video loaded successfully!');
                showStatus('Video loaded successfully! You can now play the encrypted content.', 'success');
                
                // Update button states
                document.getElementById('loadVideo').textContent = '‚úÖ Video Loaded';
                document.getElementById('loadVideo').disabled = true;
                
            } catch (error) {
                log(`Failed to load video: ${error.message}`, 'error');
                
                let errorMessage = `Failed to load video: ${error.message}`;
                let errorType = 'error';
                
                // Provide specific troubleshooting hints
                if (error.message.includes('NETWORK')) {
                    log('HINT: Make sure the content server is running (npm run serve-content)', 'error');
                } else if (error.message.includes('LICENSE') || error.message.includes('403')) {
                    errorMessage = 'License authentication failed. Check your auth token.';
                    errorType = 'auth-error';
                    log('HINT: Verify auth token and license server status', 'error');
                } else if (error.message.includes('CLEARKEY')) {
                    log('HINT: Check license server key configuration', 'error');
                }
                
                showStatus(errorMessage, errorType);
            }
        }

        // Simulate authentication failure
        async function simulateAuthFailure() {
            const originalToken = getAuthToken();
            
            log('Simulating authentication failure...');
            document.getElementById('authToken').value = 'invalid-token';
            
            try {
                await testAuth();
            } finally {
                // Restore original token after 3 seconds
                setTimeout(() => {
                    document.getElementById('authToken').value = originalToken;
                    log('Restored original auth token');
                }, 3000);
            }
        }

        // Event listeners
        document.getElementById('loadVideo').addEventListener('click', loadVideo);
        document.getElementById('testLicenseServer').addEventListener('click', testLicenseServer);
        document.getElementById('reloadConfig').addEventListener('click', async () => {
            document.getElementById('loadVideo').textContent = 'üé¨ Load Encrypted Video';
            document.getElementById('loadVideo').disabled = false;
            await loadConfig();
        });
        document.getElementById('simulateAuthFailure').addEventListener('click', simulateAuthFailure);

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            log('Page loaded, initializing...');
            
            try {
                await loadConfig();
                await initPlayer();
                
                log('Ready to load encrypted video with license server');
                showStatus('Ready! Enter auth token and click "Load Encrypted Video" to start.', 'success');
            } catch (error) {
                log('Initialization failed - you can still try loading manually', 'error');
            }
        });
    </script>
</body>
</html>