<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Test - Unencrypted Playback</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.9.3/shaka-player.compiled.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .content {
            padding: 20px;
        }
        .video-container {
            margin: 20px 0;
            text-align: center;
        }
        video {
            width: 100%;
            max-width: 800px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .info-panel {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .explanation {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 20px 0;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .test-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .test-card {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .test-card.active {
            border-color: #4caf50;
            background: #f8fff8;
        }
        @media (max-width: 768px) {
            .test-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎬 Video Test Environment</h1>
            <p>Test Unencrypted vs Encrypted Video Playback</p>
        </div>
        
        <div class="content">
            <div class="explanation">
                <h3>🧪 Video Testing</h3>
                <p>This page allows you to test both unencrypted and encrypted video playback:</p>
                <ul>
                    <li>✅ <strong>Unencrypted</strong>: Direct MP4 playback (no encryption)</li>
                    <li>🔐 <strong>Encrypted</strong>: DASH manifest with ClearKey decryption</li>
                </ul>
                <p>Start with unencrypted to verify basic video playback works!</p>
            </div>

            <div class="test-options">
                <div class="test-card" id="unencryptedCard">
                    <h3>📹 Unencrypted Video</h3>
                    <p>Direct MP4 playback</p>
                    <button onclick="loadUnencryptedVideo()">🎬 Load Original Video</button>
                </div>
                <div class="test-card" id="html5Card">
                    <h3>🎥 HTML5 Video Test</h3>
                    <p>Basic browser compatibility</p>
                    <button onclick="testHTML5Video()">🧪 Test HTML5 Video</button>
                </div>
                <div class="test-card" id="encryptedCard">
                    <h3>🔐 Encrypted Video</h3>
                    <p>DASH + ClearKey</p>
                    <button onclick="loadEncryptedVideo()">🔑 Load Encrypted Video</button>
                </div>
                </div>
            </div>

            <div class="video-container">
                <video id="video" controls poster="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjQ1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5WaWRlbyBUZXN0IFBsYXllcjwvdGV4dD48L3N2Zz4=">
                    Your browser does not support the video tag.
                </video>
            </div>

            <div class="controls">
                <button onclick="testVideoElement()">🔧 Test HTML5 Video</button>
                <button onclick="testShakaPlayer()">🎯 Test Shaka Player</button>
                <button onclick="clearPlayer()">🗑️ Clear Player</button>
                <button onclick="checkVideoFile()">📂 Check Video File</button>
            </div>

            <div id="status" class="status" style="display: none;"></div>

            <div class="info-panel">
                <h3>📋 Current Test</h3>
                <p><strong>Mode:</strong> <span id="currentMode">None</span></p>
                <p><strong>Source:</strong> <span id="currentSource">None</span></p>
                <p><strong>Player:</strong> <span id="currentPlayer">None</span></p>
            </div>

            <div class="info-panel">
                <h3>📝 Test Log</h3>
                <div id="eventLog" class="log"></div>
            </div>

            <div class="explanation">
                <h3>🔧 Available Test Files</h3>
                <ul>
                    <li><strong>Unencrypted:</strong> <code>http://localhost:8080/content/input.mp4</code></li>
                    <li><strong>Encrypted DASH:</strong> <code>http://localhost:8080/manifest.mpd</code></li>
                    <li><strong>Encrypted Video:</strong> <code>http://localhost:8080/video_encrypted.mp4</code></li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let player = null;
        let currentTest = null;

        // Logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('eventLog');
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(logEntry.trim());
        }

        // Status display function
        function showStatus(message, type = 'loading') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            statusElement.style.display = 'block';
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 5000);
            }
        }

        // Update current test info
        function updateTestInfo(mode, source, playerType) {
            document.getElementById('currentMode').textContent = mode;
            document.getElementById('currentSource').textContent = source;
            document.getElementById('currentPlayer').textContent = playerType;
            
            // Update card highlights
            document.querySelectorAll('.test-card').forEach(card => card.classList.remove('active'));
            if (mode === 'Unencrypted') {
                document.getElementById('unencryptedCard').classList.add('active');
            } else if (mode === 'Encrypted') {
                document.getElementById('encryptedCard').classList.add('active');
            }
        }

        // Initialize Shaka Player
        async function initShakaPlayer() {
            try {
                if (player) {
                    await player.destroy();
                }
                
                log('Initializing Shaka Player...');
                shaka.polyfill.installAll();
                
                if (!shaka.Player.isBrowserSupported()) {
                    throw new Error('Browser does not support Shaka Player');
                }
                
                const video = document.getElementById('video');
                player = new shaka.Player(video);
                
                player.addEventListener('error', (event) => {
                    const error = event.detail;
                    log(`Shaka Player error: ${error.message}`, 'error');
                    showStatus(`Player error: ${error.message}`, 'error');
                });
                
                log('Shaka Player initialized successfully');
                return player;
            } catch (error) {
                log(`Failed to initialize Shaka Player: ${error.message}`, 'error');
                throw error;
            }
        }

        // Test HTML5 video compatibility
        async function testHTML5Video() {
            try {
                showStatus('Testing HTML5 video compatibility...', 'loading');
                log('🧪 Testing HTML5 video element compatibility');
                
                // Check browser codec support
                log('🌐 Browser Codec Support:');
                const testVideo = document.createElement('video');
                const mp4Support = testVideo.canPlayType('video/mp4');
                const h264Support = testVideo.canPlayType('video/mp4; codecs="avc1.42E01E"');
                const aacSupport = testVideo.canPlayType('audio/mp4; codecs="mp4a.40.2"');
                
                log(`  • MP4 Container: ${mp4Support || 'not supported'}`);
                log(`  • H.264 Video: ${h264Support || 'not supported'}`);
                log(`  • AAC Audio: ${aacSupport || 'not supported'}`);
                
                if (!mp4Support || mp4Support === 'no') {
                    log('❌ Browser does not support MP4 format', 'error');
                    showStatus('❌ Browser does not support MP4 format', 'error');
                    return;
                }
                
                // Test direct video loading
                log('🎬 Testing direct video element loading...');
                
                const videoElement = document.getElementById('videoPlayer');
                videoElement.style.display = 'block';
                
                // Create HTML5 video for testing
                const htmlVideo = document.createElement('video');
                htmlVideo.controls = true;
                htmlVideo.style.width = '100%';
                htmlVideo.style.height = '400px';
                htmlVideo.src = 'http://localhost:8080/content/input.mp4';
                
                // Replace Shaka player temporarily
                const container = videoElement.parentNode;
                container.replaceChild(htmlVideo, videoElement);
                
                // Set up event listeners
                htmlVideo.addEventListener('loadstart', () => {
                    log('📥 Video loading started...');
                });
                
                htmlVideo.addEventListener('loadedmetadata', () => {
                    log(`✅ Video metadata loaded successfully!`);
                    log(`  📏 Resolution: ${htmlVideo.videoWidth}x${htmlVideo.videoHeight}`);
                    log(`  ⏱️ Duration: ${htmlVideo.duration.toFixed(2)} seconds`);
                    log(`  🎬 Can play through: ${htmlVideo.readyState >= 4 ? 'Yes' : 'Checking...'}`);
                    showStatus('✅ HTML5 video loaded successfully!', 'success');
                });
                
                htmlVideo.addEventListener('canplay', () => {
                    log('▶️ Video ready to play');
                });
                
                htmlVideo.addEventListener('error', (e) => {
                    const error = htmlVideo.error;
                    log(`❌ HTML5 video error: ${error.message} (Code: ${error.code})`, 'error');
                    
                    // Detailed error analysis
                    switch(error.code) {
                        case MediaError.MEDIA_ERR_ABORTED:
                            log('  📋 Error Type: MEDIA_ERR_ABORTED - User aborted', 'error');
                            break;
                        case MediaError.MEDIA_ERR_NETWORK:
                            log('  📋 Error Type: MEDIA_ERR_NETWORK - Network error', 'error');
                            log('  💡 Check if content server is running on port 8080', 'error');
                            break;
                        case MediaError.MEDIA_ERR_DECODE:
                            log('  📋 Error Type: MEDIA_ERR_DECODE - Video format not supported', 'error');
                            log('  💡 Video codec/format is incompatible with browser', 'error');
                            break;
                        case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:
                            log('  📋 Error Type: MEDIA_ERR_SRC_NOT_SUPPORTED - Source not supported', 'error');
                            log('  💡 File format or codec not supported by browser', 'error');
                            break;
                    }
                    
                    showStatus('❌ HTML5 video failed - see log for details', 'error');
                });
                
                htmlVideo.addEventListener('progress', () => {
                    if (htmlVideo.buffered.length > 0) {
                        const buffered = (htmlVideo.buffered.end(0) / htmlVideo.duration) * 100;
                        log(`📊 Video buffered: ${buffered.toFixed(1)}%`);
                    }
                });
                
                // Attempt to load
                htmlVideo.load();
                
                updateTestInfo('HTML5 Test', 'content/input.mp4', 'Native HTML5 Video');
                
                // Store reference to restore later
                window.originalVideoElement = videoElement;
                window.testVideoElement = htmlVideo;
                
            } catch (error) {
                log(`❌ HTML5 video test failed: ${error.message}`, 'error');
                showStatus('❌ HTML5 video test failed', 'error');
            }
        }

        // Test unencrypted video
        async function loadUnencryptedVideo() {
            try {
                showStatus('Loading unencrypted video...', 'loading');
                log('Testing unencrypted video playback');
                
                await initShakaPlayer();
                
                const videoUrl = 'http://localhost:8080/content/input.mp4';
                log(`Loading: ${videoUrl}`);
                
                // No DRM configuration needed for unencrypted content
                await player.load(videoUrl);
                
                updateTestInfo('Unencrypted', 'content/input.mp4', 'Shaka Player');
                log('✅ Unencrypted video loaded successfully!');
                showStatus('✅ Unencrypted video ready! This proves basic playback works.', 'success');
                
            } catch (error) {
                log(`❌ Failed to load unencrypted video: ${error.message}`, 'error');
                
                // Enhanced error analysis for Shaka errors
                if (error.message.includes('3016')) {
                    log('🔍 Shaka Error 3016 Analysis:', 'error');
                    log('  📋 Error Type: CONTENT_UNSUPPORTED_BY_BROWSER', 'error');
                    log('  🎯 Common Causes:', 'error');
                    log('    • Video codec not supported (need H.264/AVC)', 'error');
                    log('    • Audio codec not supported (need AAC)', 'error');
                    log('    • Container format issues', 'error');
                    log('    • Video resolution too high', 'error');
                    log('    • Missing browser codec support', 'error');
                    log('  🔧 Solutions:', 'error');
                    log('    1. Check video format with browser tools', 'error');
                    log('    2. Convert video: ffmpeg -i input.mp4 -c:v libx264 -c:a aac -profile:v baseline content/input.mp4', 'error');
                    log('    3. Try a different video file', 'error');
                    log('    4. Check browser codec support below', 'error');
                    
                    // Additional browser compatibility check
                    log('🌐 Browser Codec Support Check:', 'error');
                    const video = document.createElement('video');
                    const h264Support = video.canPlayType('video/mp4; codecs="avc1.42E01E"');
                    const aacSupport = video.canPlayType('audio/mp4; codecs="mp4a.40.2"');
                    const generalMp4 = video.canPlayType('video/mp4');
                    
                    log(`    • General MP4 Support: ${generalMp4 || 'none'}`, 'error');
                    log(`    • H.264 Support: ${h264Support || 'none'}`, 'error');
                    log(`    • AAC Support: ${aacSupport || 'none'}`, 'error');
                    
                    if (!h264Support || h264Support === 'no') {
                        log('    ❌ H.264 codec not supported by browser', 'error');
                    }
                    if (!aacSupport || aacSupport === 'no') {
                        log('    ⚠️ AAC codec not supported by browser', 'error');
                    }
                    
                    // Test direct video element loading
                    log('🧪 Testing direct HTML5 video element...', 'error');
                    const testVideo = document.createElement('video');
                    testVideo.src = 'http://localhost:8080/content/input.mp4';
                    testVideo.addEventListener('loadedmetadata', () => {
                        log(`  ✅ HTML5 video can load metadata: ${testVideo.videoWidth}x${testVideo.videoHeight}`, 'error');
                        log(`  📊 Duration: ${testVideo.duration} seconds`, 'error');
                    });
                    testVideo.addEventListener('error', (e) => {
                        log(`  ❌ HTML5 video also fails: ${e.message}`, 'error');
                        log('  💡 This confirms the video file has compatibility issues', 'error');
                    });
                    testVideo.load();
                }
                
                showStatus('❌ Unencrypted video failed to load - see log for details', 'error');
            }
        }

        // Test encrypted video
        async function loadEncryptedVideo() {
            try {
                showStatus('Loading encrypted video...', 'loading');
                log('Testing encrypted video playback');
                
                await initShakaPlayer();
                
                // Load player configuration with detailed logging
                log('Step 1: Loading player configuration...');
                const configResponse = await fetch(`/content/player-config.json?t=${Date.now()}`);
                if (!configResponse.ok) {
                    throw new Error(`Config request failed: ${configResponse.status} ${configResponse.statusText}`);
                }
                const config = await configResponse.json();
                log(`✅ Config loaded: ${JSON.stringify(config, null, 2)}`);
                
                // Validate configuration
                if (!config.clearKeys || Object.keys(config.clearKeys).length === 0) {
                    throw new Error('No clearKeys found in configuration');
                }
                
                const keyCount = Object.keys(config.clearKeys).length;
                log(`Step 2: Found ${keyCount} encryption key(s)`);
                
                // Log each key pair
                for (const [kid, key] of Object.entries(config.clearKeys)) {
                    log(`  Key ID: ${kid}`);
                    log(`  Key: ${key}`);
                    log(`  Key ID length: ${kid.length} chars`);
                    log(`  Key length: ${key.length} chars`);
                    
                    // Validate key formats
                    const kidValid = /^[0-9a-f]{32}$/i.test(kid);
                    const keyValid = /^[0-9a-f]{32}$/i.test(key);
                    log(`  Key ID format valid: ${kidValid}`);
                    log(`  Key format valid: ${keyValid}`);
                }
                
                log('Step 3: Configuring ClearKey encryption...');
                player.configure({
                    drm: {
                        clearKeys: config.clearKeys
                    }
                });
                log(`✅ ClearKey configured with ${keyCount} key(s)`);
                
                // Test manifest accessibility first
                log('Step 4: Testing manifest accessibility...');
                const manifestUrl = config.manifestUrl + `?t=${Date.now()}`;
                log(`Manifest URL: ${manifestUrl}`);
                
                const manifestResponse = await fetch(manifestUrl, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });
                if (!manifestResponse.ok) {
                    throw new Error(`Manifest request failed: ${manifestResponse.status} ${manifestResponse.statusText}`);
                }
                
                const manifestText = await manifestResponse.text();
                log(`✅ Manifest accessible, size: ${manifestText.length} bytes`);
                log(`Manifest content type: ${manifestResponse.headers.get('content-type')}`);
                
                // Check manifest content for key issues
                if (manifestText.includes('cenc:default_KID')) {
                    const kidMatch = manifestText.match(/cenc:default_KID="([^"]+)"/);
                    if (kidMatch) {
                        const manifestKid = kidMatch[1];
                        log(`Manifest KID: ${manifestKid}`);
                        
                        // Check if KID formats match
                        const normalizedManifestKid = manifestKid.replace(/-/g, '');
                        const configKids = Object.keys(config.clearKeys);
                        const kidMatches = configKids.some(configKid => 
                            configKid.toLowerCase() === normalizedManifestKid.toLowerCase()
                        );
                        log(`KID format match: ${kidMatches}`);
                        
                        if (!kidMatches) {
                            log('⚠️  WARNING: Manifest KID does not match any config KID', 'error');
                            log(`  Manifest KID (normalized): ${normalizedManifestKid}`);
                            log(`  Config KIDs: ${configKids.join(', ')}`);
                        }
                    }
                }
                
                // Check for ClearKey UUID
                if (manifestText.includes('urn:uuid:e2719d58-a985-b3c9-781a-b030af78d30e')) {
                    log('✅ Manifest contains ClearKey UUID');
                } else if (manifestText.includes('urn:uuid:')) {
                    const uuidMatch = manifestText.match(/urn:uuid:([a-f0-9-]+)/);
                    if (uuidMatch) {
                        log(`⚠️  WARNING: Manifest contains different UUID: ${uuidMatch[1]}`, 'error');
                        log('  Expected ClearKey UUID: e2719d58-a985-b3c9-781a-b030af78d30e');
                    }
                } else {
                    log('⚠️  WARNING: No DRM UUID found in manifest', 'error');
                }
                
                // Add more detailed error handling
                player.addEventListener('error', (event) => {
                    const error = event.detail;
                    log(`🔥 Shaka Player Error Details:`, 'error');
                    log(`  Code: ${error.code}`, 'error');
                    log(`  Category: ${error.category}`, 'error');
                    log(`  Severity: ${error.severity}`, 'error');
                    log(`  Message: ${error.message}`, 'error');
                    log(`  Data: ${JSON.stringify(error.data)}`, 'error');
                    
                    // Specific error code explanations
                    if (error.code === 3004) {
                        log('🔍 Error 3004 Analysis:', 'error');
                        log('  This indicates a DRM configuration or manifest parsing issue', 'error');
                        log('  Common causes:', 'error');
                        log('    - Wrong DRM scheme UUID in manifest', 'error');
                        log('    - Malformed manifest XML', 'error');
                        log('    - Missing or invalid PSSH box', 'error');
                        log('    - Incompatible protection scheme', 'error');
                    }
                });
                
                log('Step 5: Loading encrypted manifest...');
                
                // Clear any previous error handlers to avoid conflicts
                player.removeEventListener('error');
                
                // Set up error monitoring
                player.addEventListener('error', (event) => {
                    const error = event.detail;
                    log(`🚨 Shaka Error Details:`, 'error');
                    log(`  - Code: ${error.code}`, 'error');
                    log(`  - Category: ${error.category}`, 'error');
                    log(`  - Severity: ${error.severity}`, 'error');
                    log(`  - Message: ${error.message}`, 'error');
                    if (error.data) {
                        log(`  - Data: ${JSON.stringify(error.data)}`, 'error');
                    }
                });
                
                // Check if browser supports the required capabilities
                log('🔍 Checking browser EME capabilities...');
                if ('requestMediaKeySystemAccess' in navigator) {
                    try {
                        // Test basic ClearKey support
                        const keySystemConfig = [{
                            initDataTypes: ['cenc', 'webm'],
                            audioCapabilities: [
                                {contentType: 'audio/mp4; codecs="mp4a.40.2"'},
                                {contentType: 'audio/webm; codecs="opus"'}
                            ],
                            videoCapabilities: [
                                {contentType: 'video/mp4; codecs="avc1.640033"'},
                                {contentType: 'video/mp4; codecs="avc1.42E01E"'},
                                {contentType: 'video/webm; codecs="vp9"'}
                            ]
                        }];
                        
                        const access = await navigator.requestMediaKeySystemAccess('org.w3.clearkey', keySystemConfig);
                        log('✅ ClearKey system access confirmed');
                        
                    } catch (keySystemError) {
                        log(`❌ ClearKey not supported: ${keySystemError.message}`, 'error');
                        log('🔧 Trying alternative key system configurations...', 'error');
                        
                        // Try simpler config
                        try {
                            const simpleConfig = [{
                                initDataTypes: ['cenc']
                            }];
                            await navigator.requestMediaKeySystemAccess('org.w3.clearkey', simpleConfig);
                            log('✅ Basic ClearKey support confirmed');
                        } catch (simpleError) {
                            log(`❌ No ClearKey support: ${simpleError.message}`, 'error');
                        }
                    }
                } else {
                    log('❌ EME not supported in this browser', 'error');
                }
                
                log('🎬 Attempting to load manifest with Shaka Player...');
                
                // Comprehensive diagnostic checks before loading
                log('🔍 DIAGNOSTIC: Pre-load checks starting...');
                
                try {
                    // 1. Manifest URL validation
                    log(`1️⃣ Manifest URL check: ${manifestUrl}`);
                    try {
                        const urlObj = new URL(manifestUrl);
                        log(`   ✅ URL is valid: ${urlObj.href}`);
                    } catch (urlError) {
                        log(`   ❌ Invalid URL: ${urlError.message}`, 'error');
                    }
                
                // 2. Manifest content analysis
                log('2️⃣ Manifest content analysis:');
                log(`   Size: ${manifestText.length} bytes`);
                log(`   Contains video track: ${manifestText.includes('contentType="video"')}`);
                log(`   Contains ContentProtection: ${manifestText.includes('ContentProtection')}`);
                
                // 3. DRM UUID detailed check
                log('3️⃣ DRM UUID analysis:');
                const allUUIDs = manifestText.match(/urn:uuid:([a-f0-9-]+)/g) || [];
                log(`   Found UUIDs: ${allUUIDs.join(', ')}`);
                const hasClearKey = allUUIDs.some(uuid => uuid.includes('e2719d58-a985-b3c9-781a-b030af78d30e'));
                log(`   ClearKey UUID present: ${hasClearKey}`);
                
                // 4. PSSH analysis with detailed decoding
                log('4️⃣ PSSH box analysis:');
                const psshMatches = manifestText.match(/<cenc:pssh>([^<]+)<\/cenc:pssh>/g) || [];
                log(`   PSSH boxes found: ${psshMatches.length}`);
                
                psshMatches.forEach((pssh, i) => {
                    const base64Data = pssh.match(/>([^<]+)</)[1];
                    log(`   PSSH ${i + 1}: ${base64Data}`);
                    
                    try {
                        // Decode PSSH box structure
                        const psshBytes = atob(base64Data);
                        const psshArray = new Uint8Array(psshBytes.length);
                        for (let j = 0; j < psshBytes.length; j++) {
                            psshArray[j] = psshBytes.charCodeAt(j);
                        }
                        
                        // Parse PSSH box header
                        if (psshArray.length >= 32) {
                            // Extract system ID (bytes 12-27)
                            const systemId = Array.from(psshArray.slice(12, 28))
                                .map(b => b.toString(16).padStart(2, '0'))
                                .join('');
                            
                            const formattedSystemId = [
                                systemId.substring(0, 8),
                                systemId.substring(8, 12),
                                systemId.substring(12, 16),
                                systemId.substring(16, 20),
                                systemId.substring(20, 32)
                            ].join('-');
                            
                            log(`     📋 Decoded PSSH System ID: ${formattedSystemId}`);
                            
                            // Check against known DRM systems
                            const drmSystems = {
                                'e2719d58-a985-b3c9-781a-b030af78d30e': 'ClearKey',
                                '1077efec-c0b2-4d02-ace3-3c1e52e2fb4b': 'Common Encryption (Generic)',
                                'edef8ba9-79d6-4ace-a3c8-27dcd51d21ed': 'Widevine',
                                '9a04f079-9840-4286-ab92-e65be0885f95': 'PlayReady',
                                '94ce86fb-07ff-4f43-adb8-93d2fa968ca2': 'FairPlay'
                            };
                            
                            const drmType = drmSystems[formattedSystemId] || 'Unknown DRM System';
                            log(`     🎯 DRM System: ${drmType}`);
                            
                            if (formattedSystemId === 'e2719d58-a985-b3c9-781a-b030af78d30e') {
                                log(`     ✅ PSSH contains ClearKey system ID`);
                            } else {
                                log(`     ❌ PSSH contains non-ClearKey system ID: ${drmType}`, 'error');
                                log(`     💡 This is likely the root cause of Error 3004`, 'error');
                            }
                            
                            // Extract KID count and KIDs if present
                            if (psshArray.length >= 36) {
                                const kidCount = new DataView(psshArray.buffer, 32, 4).getUint32(0, false);
                                log(`     📊 Number of KIDs in PSSH: ${kidCount}`);
                                
                                if (kidCount > 0 && psshArray.length >= 36 + (kidCount * 16)) {
                                    for (let k = 0; k < kidCount; k++) {
                                        const kidStart = 36 + (k * 16);
                                        const kidBytes = psshArray.slice(kidStart, kidStart + 16);
                                        const kidHex = Array.from(kidBytes)
                                            .map(b => b.toString(16).padStart(2, '0'))
                                            .join('');
                                        log(`     🔑 KID ${k + 1}: ${kidHex}`);
                                    }
                                }
                            }
                        } else {
                            log(`     ⚠️ PSSH box too short: ${psshArray.length} bytes`);
                        }
                    } catch (decodeError) {
                        log(`     ❌ Failed to decode PSSH: ${decodeError.message}`, 'error');
                    }
                });
                
                // Additional PSSH compatibility check
                if (psshMatches.length > 0) {
                    log('   🔍 PSSH Compatibility Analysis:');
                    const hasClearKeyPSSH = manifestText.includes('e2719d58-a985-b3c9-781a-b030af78d30e');
                    const hasOtherDRMPSSH = manifestText.includes('1077efec-c0b2-4d02-ace3-3c1e52e2fb4b');
                    
                    log(`     ClearKey UUID in manifest: ${hasClearKeyPSSH}`);
                    log(`     Other DRM UUID in manifest: ${hasOtherDRMPSSH}`);
                    
                    if (!hasClearKeyPSSH && hasOtherDRMPSSH) {
                        log(`     🚨 PROBLEM: Manifest uses ClearKey UUID but PSSH contains different DRM data`, 'error');
                        log(`     💡 Solution: Remove PSSH box or generate ClearKey-compatible PSSH`, 'error');
                    }
                }
                
                // 5. Key ID consistency check
                log('5️⃣ Key ID consistency check:');
                const manifestKID = manifestText.match(/cenc:default_KID="([^"]+)"/)?.[1];
                const configKIDs = Object.keys(config.clearKeys);
                log(`   Manifest KID: ${manifestKID}`);
                log(`   Config KIDs: ${configKIDs.join(', ')}`);
                
                // 6. Player state check
                log('6️⃣ Player state check:');
                const videoElement = document.getElementById('video');
                log(`   Video element exists: ${!!videoElement}`);
                log(`   Player initialized: ${!!player}`);
                log(`   Player version: ${shaka.Player.version}`);
                
                // 7. Browser capabilities detailed check
                log('7️⃣ Browser capabilities:');
                log(`   EME support: ${!!navigator.requestMediaKeySystemAccess}`);
                log(`   ClearKey support: Testing...`);
                
                try {
                    await navigator.requestMediaKeySystemAccess('org.w3.clearkey', [{
                        initDataTypes: ['cenc'],
                        videoCapabilities: [{contentType: 'video/mp4; codecs="avc1.640033"'}]
                    }]);
                    log(`   ✅ ClearKey with CENC supported`);
                } catch (clearKeyError) {
                    log(`   ❌ ClearKey test failed: ${clearKeyError.message}`, 'error');
                }
                
                log('🔍 DIAGNOSTIC: All pre-checks complete, attempting load...');
                
                } catch (diagnosticError) {
                    log(`⚠️  Diagnostic check failed: ${diagnosticError.message}`, 'error');
                    log('Continuing with player load attempt...');
                }
                
                await player.load(manifestUrl);
                
                updateTestInfo('Encrypted', 'manifest.mpd', 'Shaka Player + ClearKey');
                log('✅ Encrypted video loaded successfully!');
                showStatus('✅ Encrypted video ready! Encryption pipeline working.', 'success');
                
            } catch (error) {
                log(`❌ Failed to load encrypted video: ${error.message}`, 'error');
                log(`Error stack: ${error.stack}`, 'error');
                
                // Comprehensive error analysis
                log('🔥 ERROR ANALYSIS:', 'error');
                log(`   Error type: ${error.constructor.name}`, 'error');
                log(`   Error code: ${error.code || 'No code'}`, 'error');
                log(`   Error category: ${error.category || 'No category'}`, 'error');
                log(`   Error severity: ${error.severity || 'No severity'}`, 'error');
                
                // Shaka-specific error analysis
                if (error.message.includes('Shaka Error')) {
                    const errorCode = error.message.match(/Shaka Error (\d+)/)?.[1];
                    log(`🎯 Shaka Error Code: ${errorCode}`, 'error');
                    
                    switch (errorCode) {
                        case '3004':
                            log('📋 Error 3004 Analysis:', 'error');
                            log('   - DRM configuration failed', 'error');
                            log('   - Possible causes:', 'error');
                            log('     • Incompatible DRM UUID in manifest', 'error');
                            log('     • PSSH box format mismatch', 'error');
                            log('     • Browser EME restrictions', 'error');
                            log('     • Key system initialization failure', 'error');
                            break;
                        case '3016':
                            log('📋 Error 3016 Analysis:', 'error');
                            log('   - License request failed', 'error');
                            break;
                        default:
                            log(`📋 Unknown Shaka Error: ${errorCode}`, 'error');
                    }
                }
                
                // Runtime environment check
                log('🌐 Runtime Environment Check:', 'error');
                log(`   User Agent: ${navigator.userAgent}`, 'error');
                log(`   Is HTTPS: ${location.protocol === 'https:'}`, 'error');
                log(`   Is localhost: ${location.hostname === 'localhost'}`, 'error');
                
                // Additional context for common issues
                if (error.message.includes('3004')) {
                    log('🔧 Troubleshooting suggestions:', 'error');
                    log('  1. Check manifest DRM UUID (should be ClearKey UUID)', 'error');
                    log('  2. Verify KID format consistency (no dashes)', 'error');
                    log('  3. Ensure manifest is valid XML', 'error');
                    log('  4. Check browser EME support', 'error');
                    log('  5. Verify PSSH box compatibility', 'error');
                    log('  6. Test with different browser', 'error');
                }
                
                showStatus(`Failed to load encrypted video: ${error.message}`, 'error');
            }
        }

        // Test with native HTML5 video element
        async function testVideoElement() {
            try {
                showStatus('Testing HTML5 video element...', 'loading');
                log('Testing native HTML5 video playback');
                
                if (player) {
                    await player.destroy();
                    player = null;
                }
                
                const video = document.getElementById('video');
                video.src = 'http://localhost:8080/content/input.mp4';
                
                video.addEventListener('loadeddata', () => {
                    log('✅ HTML5 video loaded successfully');
                    showStatus('✅ HTML5 video works! Browser can play MP4 files.', 'success');
                });
                
                video.addEventListener('error', (e) => {
                    log(`HTML5 video error: ${e.message}`, 'error');
                    showStatus('❌ HTML5 video failed', 'error');
                });
                
                updateTestInfo('Unencrypted', 'content/input.mp4', 'HTML5 Video');
                log('HTML5 video element configured');
                
            } catch (error) {
                log(`HTML5 video test failed: ${error.message}`, 'error');
                showStatus(`HTML5 video test failed: ${error.message}`, 'error');
            }
        }

        // Test Shaka Player without encryption
        async function testShakaPlayer() {
            try {
                showStatus('Testing Shaka Player capabilities...', 'loading');
                log('Testing Shaka Player without encryption');
                
                await initShakaPlayer();
                
                // Test with unencrypted content first
                await player.load('http://localhost:8080/content/input.mp4');
                
                updateTestInfo('Unencrypted', 'content/input.mp4', 'Shaka Player');
                log('✅ Shaka Player working with unencrypted content');
                showStatus('✅ Shaka Player works! Ready for encrypted content.', 'success');
                
            } catch (error) {
                log(`Shaka Player test failed: ${error.message}`, 'error');
                showStatus(`Shaka Player test failed: ${error.message}`, 'error');
            }
        }

        // Clear player
        async function clearPlayer() {
            try {
                const video = document.getElementById('video');
                
                if (player) {
                    await player.destroy();
                    player = null;
                }
                
                video.removeAttribute('src');
                video.load(); // Reset video element
                
                updateTestInfo('None', 'None', 'None');
                log('Player cleared');
                showStatus('Player cleared', 'success');
                
            } catch (error) {
                log(`Failed to clear player: ${error.message}`, 'error');
            }
        }

        // Check if video file exists
        async function checkVideoFile() {
            try {
                showStatus('Checking video file...', 'loading');
                log('🔍 Comprehensive file accessibility check');
                
                const testUrls = [
                    'http://localhost:8080/content/input.mp4',
                    'http://localhost:8080/video_encrypted.mp4',
                    'http://localhost:8080/manifest.mpd',
                    'http://localhost:8080/player-config.json'
                ];
                
                let allGood = true;
                
                for (const url of testUrls) {
                    try {
                        log(`\n📁 Checking: ${url}`);
                        
                        // HEAD request to check availability
                        const headResponse = await fetch(url, { method: 'HEAD' });
                        if (headResponse.ok) {
                            const contentLength = headResponse.headers.get('content-length');
                            const contentType = headResponse.headers.get('content-type');
                            log(`  ✅ Status: ${headResponse.status} ${headResponse.statusText}`);
                            log(`  📏 Size: ${contentLength ? `${contentLength} bytes` : 'Unknown'}`);
                            log(`  📄 Type: ${contentType || 'Unknown'}`);
                            
                            // For manifest, do additional checks
                            if (url.includes('manifest.mpd')) {
                                const getResponse = await fetch(url);
                                const manifestContent = await getResponse.text();
                                
                                log(`  📋 Manifest analysis:`);
                                log(`    - Length: ${manifestContent.length} characters`);
                                log(`    - Has CENC: ${manifestContent.includes('cenc') ? 'Yes' : 'No'}`);
                                log(`    - Has ContentProtection: ${manifestContent.includes('ContentProtection') ? 'Yes' : 'No'}`);
                                log(`    - Has KID: ${manifestContent.includes('default_KID') ? 'Yes' : 'No'}`);
                                
                                // Check UUID
                                if (manifestContent.includes('urn:uuid:e2719d58-a985-b3c9-781a-b030af78d30e')) {
                                    log(`    - DRM UUID: ClearKey (✅ Correct)`);
                                } else if (manifestContent.includes('urn:uuid:')) {
                                    const uuidMatch = manifestContent.match(/urn:uuid:([a-f0-9-]+)/);
                                    log(`    - DRM UUID: ${uuidMatch ? uuidMatch[1] : 'Unknown'} (❌ Wrong)`);
                                    allGood = false;
                                } else {
                                    log(`    - DRM UUID: Not found (❌ Missing)`);
                                    allGood = false;
                                }
                                
                                // Extract and validate KID
                                const kidMatch = manifestContent.match(/cenc:default_KID="([^"]+)"/);
                                if (kidMatch) {
                                    const manifestKid = kidMatch[1];
                                    log(`    - Manifest KID: ${manifestKid}`);
                                    
                                    // Check format
                                    const hasDashes = manifestKid.includes('-');
                                    log(`    - KID format: ${hasDashes ? 'With dashes' : 'No dashes'}`);
                                    
                                    if (hasDashes) {
                                        log(`    - ⚠️  Warning: ClearKey prefers KID without dashes`);
                                    }
                                }
                            }
                            
                            // For player config, validate keys
                            if (url.includes('player-config.json')) {
                                const getResponse = await fetch(url);
                                const config = await getResponse.json();
                                
                                log(`  🔑 Player config analysis:`);
                                const keyCount = Object.keys(config.clearKeys || {}).length;
                                log(`    - Clear keys: ${keyCount}`);
                                
                                if (keyCount > 0) {
                                    for (const [kid, key] of Object.entries(config.clearKeys)) {
                                        log(`    - KID: ${kid} (${kid.length} chars)`);
                                        log(`    - Key: ${key} (${key.length} chars)`);
                                        
                                        const kidValid = /^[0-9a-f]{32}$/i.test(kid);
                                        const keyValid = /^[0-9a-f]{32}$/i.test(key);
                                        log(`    - Formats valid: KID=${kidValid}, Key=${keyValid}`);
                                        
                                        if (!kidValid || !keyValid) {
                                            allGood = false;
                                        }
                                    }
                                } else {
                                    log(`    - ❌ No clear keys found`);
                                    allGood = false;
                                }
                            }
                            
                        } else {
                            log(`  ❌ Not found: ${headResponse.status} ${headResponse.statusText}`, 'error');
                            allGood = false;
                        }
                    } catch (error) {
                        log(`  ❌ Error checking ${url}: ${error.message}`, 'error');
                        allGood = false;
                    }
                }
                
                log(`\n🎯 Overall assessment: ${allGood ? '✅ All checks passed' : '❌ Issues found'}`);
                showStatus(`File check completed - ${allGood ? 'All good!' : 'Issues found, see log'}`, allGood ? 'success' : 'error');
                
                if (!allGood) {
                    log('\n🔧 Recommended fixes:', 'error');
                    log('  1. Regenerate content: npm run package-video', 'error');
                    log('  2. Check manifest DRM UUID', 'error');
                    log('  3. Verify key formats', 'error');
                    log('  4. Restart servers', 'error');
                }
                
            } catch (error) {
                log(`File check failed: ${error.message}`, 'error');
                showStatus('File check failed', 'error');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            log('Video test environment loaded');
            log('💡 Start with "Load Original Video" to test basic playback');
            showStatus('Ready! Start with unencrypted video to test basic playback.', 'success');
        });
    </script>
</body>
</html>